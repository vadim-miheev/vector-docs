services:
  react-build:
    profiles: ["prod"]
    image: node:22.18
    container_name: react-build
    working_dir: /app
    volumes:
      - ./frontend/react-app:/app
      - react-npm-cache:/npm-cache
      - react-node-modules:/app/node_modules
    environment:
      REACT_APP_DEMO_USER_ID: ${DEMO_USER_ID:-0}
      NPM_CONFIG_CACHE: /npm-cache
    command: sh -c "npm ci && npm run build"
    restart: "no"

  react-nginx:
    profiles: ["prod"]
    image: nginx:alpine
    container_name: react-nginx
    restart: unless-stopped
    depends_on:
      react-build:
        condition: service_completed_successfully
    volumes:
      - ./frontend/react-app/build:/usr/share/nginx/html:ro
      - ./frontend/nginx:/etc/nginx/conf.d:ro

volumes:
  react-npm-cache:
  react-node-modules: